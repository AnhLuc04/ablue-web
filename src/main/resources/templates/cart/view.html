
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Gi·ªè h√†ng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="container py-5">

<h2 class="mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

<form id="cart-form">
  <table class="table table-bordered text-center align-middle">
    <thead class="table-dark">
    <tr>
      <th><input type="checkbox" id="select-all" /></th>
      <th>S·∫£n ph·∫©m</th>
      <th>Gi√°</th>
      <th>S·ªë l∆∞·ª£ng</th>
      <th>Th√†nh ti·ªÅn</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="item : ${cart.items}">
      <td>
        <input type="checkbox" class="item-checkbox" th:attr="data-id=${item.id}" />
      </td>
      <td>
        <strong th:text="${item.variation.product.name}">T√™n s·∫£n ph·∫©m</strong><br/>
        <small th:if="${item.variation != null}">
          Bi·∫øn th·ªÉ:
          <span th:each="attr, attrStat : ${item.variation.attributes}">
        <span th:text="${attr.attributeTerm.name}">T√™n</span>
        <span th:if="${!attrStat.last}"> / </span>
    </span>
        </small><br/>

        <small th:if="${item.variation.salePrice lt item.variation.regularPrice}" class="text-danger">
          üî• Gi·∫£m c√≤n <span th:text="${item.variation.salePrice}">0</span>
          (<del th:text="${item.variation.regularPrice}">0</del>)
        </small>
      </td>
      <td>$<span th:id="'price-' + ${item.id}" th:text="${item.variation.salePrice}">0</span></td>
      <td>
        <div class="d-flex justify-content-center align-items-center gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm update-qty"
                  th:attr="data-id=${item.id},data-action='decrease'">-</button>
          <span th:id="'qty-' + ${item.id}" th:text="${item.quantity}">1</span>
          <button type="button" class="btn btn-outline-secondary btn-sm update-qty"
                  th:attr="data-id=${item.id},data-action='increase'">+</button>
        </div>
      </td>
      <td>
        $<span th:id="'subtotal-' + ${item.id}"
               th:text="${(item.variation.salePrice != null ? item.variation.salePrice : 0) * item.quantity}">0</span>
      </td>
    </tr>
    </tbody>
  </table>
</form>

<div class="text-end mt-3">
  <h4>T·ªïng ti·ªÅn: <span id="total-price">$0.00</span></h4>
</div>

<h5 id="discount-info" class="text-success mt-2"></h5>
<select id="discount-select" class="form-select mt-3">
  <option value="">-- Ch·ªçn m√£ gi·∫£m gi√° --</option>
</select>
<button id="apply-discount" class="btn btn-success mt-2">√Åp d·ª•ng m√£</button>
<div class="text-end mt-4">
  <button type="button" id="checkout-btn" class="btn btn-primary btn-lg">üõçÔ∏è Mua h√†ng</button>
</div>

<script>

  // Khi nh·∫•n "Mua h√†ng"
  $("#checkout-btn").click(function () {
    const selectedItems = [];

    $(".item-checkbox:checked").each(function () {
      const itemId = $(this).data("id");
      const qty = parseInt($("#qty-" + itemId).text()) || 1;
      selectedItems.push({ itemId, quantity: qty });
    });

    if (selectedItems.length === 0) {
      alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m ƒë·ªÉ mua.");
      return;
    }

    // G·ª≠i selectedItems qua POST v√† chuy·ªÉn sang trang thanh to√°n
    $.ajax({
      url: "/checkout",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(selectedItems),
      success: function () {
        window.location.href = "/checkout";
      },
      error: function () {
        alert("L·ªói khi x·ª≠ l√Ω thanh to√°n.");
      }
    });
  });



  let selectedDiscount = null;

  function formatCurrency(amount) {
    return '$' + Number(amount).toFixed(2);
  }

  function calculateTotal() {
    let total = 0;

    $(".item-checkbox:checked").each(function () {
      const itemId = $(this).data("id");
      const qty = parseInt($("#qty-" + itemId).text()) || 1;
      const price = parseFloat($("#price-" + itemId).text()) || 0;
      total += price * qty;
    });

    // √Åp d·ª•ng m√£ gi·∫£m gi√° n·∫øu c√≥
    if (selectedDiscount) {
      if (selectedDiscount.percentage) {
        total = total - (total * selectedDiscount.discountAmount / 100);
      } else {
        total = total - selectedDiscount.discountAmount;
      }
      if (total < 0) total = 0;
    }

    $("#total-price").text(formatCurrency(total));
  }

  $(document).ready(function () {
    // ‚úÖ M·∫∑c ƒë·ªãnh ch·ªçn t·∫•t c·∫£ item
    $(".item-checkbox").prop("checked", true);
    $("#select-all").prop("checked", true);

    // Load m√£ gi·∫£m gi√° t·ª´ server
    $.get("/cart/discounts", function (data) {
      data.forEach(function (discount) {
        const label = discount.percentage
          ? discount.code + " - " + discount.discountAmount + "%"
          : discount.code + " - " + formatCurrency(discount.discountAmount);
        $("#discount-select").append(`<option value='${JSON.stringify(discount)}'>${label}</option>`);
      });
    });

    // √Åp d·ª•ng m√£ gi·∫£m gi√°
    $("#apply-discount").click(function () {
      const selectedOption = $("#discount-select").val();
      selectedDiscount = selectedOption ? JSON.parse(selectedOption) : null;
      calculateTotal();
    });

    // TƒÉng/gi·∫£m s·ªë l∆∞·ª£ng
    $(document).on("click", ".update-qty", function () {
      const itemId = $(this).data("id");
      const action = $(this).data("action");
      const $qty = $("#qty-" + itemId);
      let qty = parseInt($qty.text());

      if (action === "increase") qty++;
      else if (action === "decrease" && qty > 1) qty--;

      $qty.text(qty);

      const price = parseFloat($("#price-" + itemId).text()) || 0;
      const newSubtotal = price * qty;
      $("#subtotal-" + itemId).text(newSubtotal.toFixed(2));

      $.post("/cart/update-ajax", { itemId, action });

      calculateTotal();
    });

    // Ch·ªçn t·∫•t c·∫£
    $("#select-all").on("change", function () {
      $(".item-checkbox").prop("checked", this.checked);
      calculateTotal();
    });

    // Ch·ªçn t·ª´ng d√≤ng
    $(".item-checkbox").on("change", function () {
      calculateTotal();
    });

    // ‚úÖ T√≠nh t·ªïng l·∫ßn ƒë·∫ßu
    calculateTotal();
  });
</script>

</body>
</html>